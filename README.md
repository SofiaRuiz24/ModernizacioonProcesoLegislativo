# Sistema de Modernizaci√≥n del Proceso Legislativo

Sistema integral de gesti√≥n legislativa con integraci√≥n blockchain para votaciones transparentes y trazables, desarrollado con React, Node.js, MongoDB y Smart Contracts en Solidity.

## üèóÔ∏è Arquitectura del Sistema

### Frontend (React + TypeScript)
- **Framework**: React con TypeScript y Vite
- **UI Components**: Componentes personalizados con Tailwind CSS
- **Estado**: React Hooks para manejo de estado local
- **Autenticaci√≥n**: Integraci√≥n con MetaMask + JWT tradicional
- **Tema**: Soporte para modo oscuro/claro

### Backend (Node.js)
- **Framework**: Express.js
- **Base de Datos**: MongoDB con Mongoose
- **Autenticaci√≥n**: JWT + verificaci√≥n de firmas Web3
- **Blockchain**: Integraci√≥n con Ethereum (Red Sepolia)
- **Storage**: Sistema de archivos para documentos PDF

### Blockchain (Solidity)
- **Red**: Ethereum Sepolia Testnet
- **Wallet**: MetaMask para autenticaci√≥n y firmas
- **Smart Contract**: `VotacionLegislatura.sol`

## üìä Funcionalidades Principales

### 1. Gesti√≥n de Legisladores
- Registro y administraci√≥n de legisladores
- Estados: Activo, Licencia, Suspendido
- Informaci√≥n de contacto y afiliaci√≥n partidaria
- Historial de proyectos presentados

### 2. Sistema de Votaci√≥n Blockchain
- Votaciones transparentes y auditables
- Tipos de voto: A favor, En contra, Abstenci√≥n, Presente, Ausente
- Integraci√≥n con MetaMask para firmas digitales
- Trazabilidad completa en blockchain

### 3. Gesti√≥n de Sesiones Legislativas
- Creaci√≥n y administraci√≥n de sesiones
- Agenda de leyes a tratar
- Control de estado de sesiones

### 4. Administraci√≥n de Leyes
- Presentaci√≥n de nuevos proyectos de ley
- Seguimiento de estado y progreso
- Carga de documentos PDF
- Sistema de categorizaci√≥n

### 5. B√∫squeda y Archivo
- B√∫squeda avanzada con m√∫ltiples filtros
- Archivo hist√≥rico de proyectos
- Estad√≠sticas y m√©tricas

## üõ†Ô∏è API Endpoints

### Autenticaci√≥n y Autorizaci√≥n
```
POST /api/auth/login              # Login tradicional
POST /api/auth/logout             # Cerrar sesi√≥n
POST /api/auth/refresh-token      # Renovar token
GET  /api/auth/me                 # Obtener usuario actual
POST /api/auth/change-password    # Cambiar contrase√±a
```

### Gesti√≥n de Legisladores
```
GET    /api/legislators                    # Listar todos con filtros
POST   /api/legislators                    # Crear nuevo legislador
GET    /api/legislators/:id               # Obtener legislador espec√≠fico
PUT    /api/legislators/:id               # Actualizar legislador
DELETE /api/legislators/:id               # Eliminar legislador
PATCH  /api/legislators/:id/status        # Cambiar estado
GET    /api/legislators/:id/projects      # Proyectos de un legislador
```

### Gesti√≥n de Sesiones Legislativas
```
GET    /api/sessions                      # Listar sesiones
POST   /api/sessions                      # Crear nueva sesi√≥n
GET    /api/sessions/:id                  # Obtener sesi√≥n espec√≠fica
PUT    /api/sessions/:id                  # Actualizar sesi√≥n
DELETE /api/sessions/:id                  # Eliminar sesi√≥n
PATCH  /api/sessions/:id/finalize         # Finalizar sesi√≥n
GET    /api/sessions/active               # Obtener sesi√≥n activa
```

### Gesti√≥n de Leyes
```
GET    /api/laws                          # Listar leyes con filtros
POST   /api/laws                          # Crear nueva ley
GET    /api/laws/:id                      # Obtener ley espec√≠fica
PUT    /api/laws/:id                      # Actualizar ley
DELETE /api/laws/:id                      # Eliminar ley
GET    /api/laws/:id/votes                # Obtener votos de una ley
POST   /api/laws/:id/upload-document      # Subir documento PDF
GET    /api/laws/:id/document             # Descargar documento
```

### Sistema de Votaci√≥n (Blockchain)
```
POST   /api/voting/vote                   # Registrar voto
GET    /api/voting/session/:sessionId/law/:lawId/results  # Resultados
GET    /api/voting/legislator/:address/votes  # Votos de un legislador
POST   /api/voting/register-legislator    # Registrar en blockchain
POST   /api/voting/create-session         # Crear sesi√≥n en blockchain
POST   /api/voting/add-law-to-session     # Agregar ley a sesi√≥n
```

### B√∫squeda y Archivo
```
GET    /api/archive/search                # B√∫squeda avanzada
GET    /api/archive/projects              # Proyectos archivados
GET    /api/archive/laws                  # Leyes archivadas
GET    /api/archive/statistics            # Estad√≠sticas hist√≥ricas
```

### Dashboard y M√©tricas
```
GET    /api/dashboard/stats               # Estad√≠sticas generales
GET    /api/dashboard/pending-votes       # Votos pendientes
GET    /api/dashboard/recent-activity     # Actividad reciente
GET    /api/dashboard/upcoming-sessions   # Pr√≥ximas sesiones
```

### Integraciones Web3/MetaMask
```
POST   /api/web3/connect                  # Conectar wallet
POST   /api/web3/verify-signature         # Verificar firma de MetaMask
GET    /api/web3/contract-info            # Informaci√≥n del contrato
POST   /api/web3/deploy-contract          # Desplegar contrato (admin)
```

## üìÅ Modelos de Base de Datos (MongoDB)

### User Schema
```javascript
{
  _id: ObjectId,
  walletAddress: String,        // MetaMask address
  name: String,
  email: String,
  phone: String,
  party: String,               // Partido pol√≠tico
  status: String,              // 'Activo', 'Licencia', 'Suspendido'
  role: String,                // 'admin', 'legislador'
  avatar: String,
  createdAt: Date,
  updatedAt: Date,
  isRegisteredOnBlockchain: Boolean
}
```

### Session Schema
```javascript
{
  _id: ObjectId,
  blockchainSessionId: Number,
  title: String,
  description: String,
  date: Date,
  status: String,              // 'active', 'finalized', 'scheduled'
  laws: [ObjectId],           // Referencias a laws
  createdBy: ObjectId,
  createdAt: Date,
  updatedAt: Date
}
```

### Law Schema
```javascript
{
  _id: ObjectId,
  blockchainLawId: Number,
  sessionId: ObjectId,
  title: String,
  description: String,
  author: ObjectId,
  category: String,
  status: String,              // 'En revisi√≥n', 'Pendiente', 'En debate'
  datePresented: Date,
  dateExpiry: Date,
  documentUrl: String,
  votes: {
    favor: Number,
    contra: Number,
    abstenciones: Number,
    ausentes: Number
  },
  createdAt: Date,
  updatedAt: Date
}
```

### Vote Schema
```javascript
{
  _id: ObjectId,
  sessionId: Number,
  lawId: Number,
  legislatorAddress: String,
  vote: String,                // 'A_FAVOR', 'EN_CONTRA', 'ABSTENCION', 'AUSENTE', 'PRESENTE'
  txHash: String,
  blockNumber: Number,
  timestamp: Date,
  createdAt: Date
}
```

## ‚öôÔ∏è Configuraci√≥n del Entorno

### Variables de Entorno (.env)
```bash
# Blockchain Configuration
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/YOUR_PROJECT_ID
PRIVATE_KEY=YOUR_DEPLOYER_PRIVATE_KEY
CONTRACT_ADDRESS=DEPLOYED_CONTRACT_ADDRESS
CHAIN_ID=11155111

# Database
MONGODB_URI=mongodb://localhost:27017/legislative_system

# Authentication
JWT_SECRET=your_jwt_secret
JWT_EXPIRES_IN=24h

# File Storage
UPLOAD_PATH=./uploads
MAX_FILE_SIZE=10MB

# Server
PORT=3000
NODE_ENV=development
```

## üîê Autenticaci√≥n H√≠brida

### Autenticaci√≥n Tradicional
- Login con usuario y contrase√±a
- JWT tokens para sesiones
- Refresh tokens para renovaci√≥n autom√°tica

### Autenticaci√≥n Web3
- Conectar wallet MetaMask
- Verificaci√≥n de firmas digitales
- Autenticaci√≥n sin contrase√±as

### Middleware de Verificaci√≥n
```javascript
const verifyMetaMaskSignature = async (req, res, next) => {
  const { signature, message, address } = req.body;
  
  try {
    const recoveredAddress = ethers.utils.verifyMessage(message, signature);
    if (recoveredAddress.toLowerCase() !== address.toLowerCase()) {
      return res.status(401).json({ error: 'Invalid signature' });
    }
    
    req.userAddress = address;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Authentication failed' });
  }
};
```

## üîó Integraci√≥n con Smart Contract

### Smart Contract: VotacionLegislatura.sol

El contrato principal del sistema est√° desarrollado en Solidity ^0.8.0 y maneja toda la l√≥gica de votaci√≥n de manera transparente e inmutable.

#### Estructuras Principales

```solidity
enum EstadoVoto { AUSENTE, PRESENTE, A_FAVOR, EN_CONTRA, ABSTENCION }

struct Ley {
    uint256 id;
    string titulo;
    string descripcion;
    uint256 votosAFavor;
    uint256 votosEnContra;
    uint256 abstenciones;
    uint256 ausentes;
    bool activa;
}

struct Sesion {
    uint256 id;
    string fecha;
    string descripcion;
    bool activa;
    uint256[] leyesIds;
}
```

#### Funciones Principales del Smart Contract

**Gesti√≥n de Legisladores (Solo Administrador)**
```solidity
function registrarLegislador(address _legislador) public soloAdministrador
function eliminarLegislador(address _legislador) public soloAdministrador
```

**Gesti√≥n de Sesiones (Solo Administrador)**
```solidity
function crearSesion(string memory _fecha, string memory _descripcion) public soloAdministrador
function agregarLey(uint256 _idSesion, string memory _titulo, string memory _descripcion) public soloAdministrador
function finalizarSesion(uint256 _idSesion) public soloAdministrador
```

**Sistema de Votaci√≥n (Solo Legisladores)**
```solidity
function registrarVoto(uint256 _idSesion, uint256 _idLey, EstadoVoto _estadoVoto) public soloLegislador
```

**Funciones de Consulta (P√∫blicas)**
```solidity
function obtenerResultadosLey(uint256 _idSesion, uint256 _idLey) public view returns (uint256, uint256, uint256, uint256)
function obtenerVotoLegislador(uint256 _idSesion, uint256 _idLey, address _legislador) public view returns (EstadoVoto)
function obtenerLey(uint256 _idSesion, uint256 _idLey) public view returns (uint256, string memory, string memory, bool)
```

#### Eventos del Smart Contract
```solidity
event LegisladorRegistrado(address legislador);
event LegisladorEliminado(address legislador);
event SesionCreada(uint256 idSesion, string fecha);
event LeyAgregada(uint256 idSesion, uint256 idLey, string titulo);
event VotoRegistrado(uint256 idSesion, uint256 idLey, address legislador, EstadoVoto voto);
event SesionFinalizada(uint256 idSesion);
```

#### Caracter√≠sticas de Seguridad

1. **Modificadores de Acceso**:
   - `soloAdministrador`: Solo el deployer del contrato puede ejecutar funciones administrativas
   - `soloLegislador`: Solo direcciones registradas como legisladores pueden votar
   - `sesionActiva`: Solo permite acciones en sesiones activas

2. **Validaciones**:
   - Verificaci√≥n de existencia de sesiones y leyes
   - Control de estados de votaci√≥n
   - Prevenci√≥n de doble registro de legisladores
   - Validaci√≥n de tipos de voto permitidos

3. **Gesti√≥n de Estado**:
   - Permite cambio de votos antes del cierre de sesi√≥n
   - Actualizaci√≥n autom√°tica de contadores
   - Control de consistencia de datos

### Configuraci√≥n de Ethers.js
```javascript
const ethers = require('ethers');
const contractABI = require('./VotacionLegislatura.json');

const provider = new ethers.providers.JsonRpcProvider(process.env.SEPOLIA_RPC_URL);
const signer = new ethers.Wallet(process.env.PRIVATE_KEY, provider);
const contract = new ethers.Contract(process.env.CONTRACT_ADDRESS, contractABI, signer);
```

### Ejemplo de Registro de Voto
```javascript
const registerVote = async (sessionId, lawId, legislatorAddress, voteType) => {
  try {
    const tx = await contract.registrarVoto(sessionId, lawId, voteType);
    const receipt = await tx.wait();
    
    // Guardar en MongoDB para consultas r√°pidas
    await Vote.create({
      sessionId,
      lawId,
      legislatorAddress,
      vote: voteType,
      txHash: receipt.transactionHash,
      blockNumber: receipt.blockNumber,
      timestamp: new Date()
    });
    
    return receipt;
  } catch (error) {
    throw new Error(`Error registering vote: ${error.message}`);
  }
};
```

### Integraci√≥n Frontend-Backend-Blockchain

#### Flujo de Votaci√≥n
1. **Frontend**: Legislador selecciona su voto en la interfaz
2. **MetaMask**: Solicita firma de transacci√≥n al legislador
3. **Smart Contract**: Valida y registra el voto en blockchain
4. **Backend**: Escucha eventos del contrato y actualiza MongoDB
5. **Frontend**: Actualiza la UI con los resultados en tiempo real

#### Sincronizaci√≥n de Datos
```javascript
// Escuchar eventos del contrato
contract.on("VotoRegistrado", async (idSesion, idLey, legislador, voto, event) => {
  console.log(`Voto registrado: ${legislador} vot√≥ ${voto} en ley ${idLey}`);
  
  // Actualizar base de datos
  await updateVoteInDatabase({
    sessionId: idSesion,
    lawId: idLey,
    legislatorAddress: legislador,
    vote: voto,
    txHash: event.transactionHash,
    blockNumber: event.blockNumber
  });
  
  // Notificar a clientes conectados via WebSocket
  io.emit('voteUpdated', {
    sessionId: idSesion,
    lawId: idLey,
    results: await getVoteResults(idSesion, idLey)
  });
});
```

## üöÄ Instalaci√≥n y Despliegue

### Prerequisitos
- Node.js 18+
- MongoDB
- MetaMask wallet
- Cuenta en Sepolia testnet con ETH

### Instalaci√≥n del Cliente
```bash
cd client
npm install
npm run dev
```

### Instalaci√≥n del Servidor
```bash
cd server
npm install
cp .env.example .env
# Configurar variables de entorno
npm run dev
```

### Despliegue del Smart Contract
```bash
cd server
npx hardhat compile
npx hardhat deploy --network sepolia
# Copiar la direcci√≥n del contrato al .env
```

## üìã Funcionalidades por Componente

### Frontend Components
- **Header.tsx**: Navegaci√≥n principal con autenticaci√≥n
- **DashboardLayout.tsx**: Layout del dashboard con sidebar
- **PendingLaws.tsx**: Gesti√≥n de leyes pendientes y votaci√≥n
- **Legislators.tsx**: CRUD de legisladores
- **SubmitLaw.tsx**: Formulario de presentaci√≥n de leyes
- **ArchiveSearch.tsx**: B√∫squeda avanzada en archivo
- **LoginPage.tsx**: Autenticaci√≥n h√≠brida
- **ThemeProvider.tsx**: Manejo de temas oscuro/claro

### Caracter√≠sticas Destacadas
1. **Votaci√≥n Transparente**: Todos los votos quedan registrados en blockchain
2. **Trazabilidad Completa**: Historial inmutable de decisiones
3. **Interfaz Intuitiva**: UI moderna y responsive
4. **B√∫squeda Avanzada**: Filtros m√∫ltiples para encontrar informaci√≥n
5. **Dashboard Anal√≠tico**: M√©tricas y estad√≠sticas en tiempo real
6. **Gesti√≥n de Documentos**: Carga y descarga de PDFs
7. **Notificaciones**: Sistema de alertas y recordatorios
8. **Audit Trail**: Registro completo de todas las acciones

## üîß Desarrollo

### Estructura del Proyecto
```
ModernizacioonProcesoLegislativo/
‚îú‚îÄ‚îÄ client/                 # Frontend React
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Componentes UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/        # P√°ginas principales
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ lib/          # Utilidades
‚îú‚îÄ‚îÄ server/                # Backend Node.js
‚îÇ   ‚îú‚îÄ‚îÄ routes/           # Endpoints API
‚îÇ   ‚îú‚îÄ‚îÄ models/           # Modelos MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Middleware personalizado
‚îÇ   ‚îú‚îÄ‚îÄ contracts/        # Smart contracts
‚îÇ   ‚îî‚îÄ‚îÄ utils/           # Utilidades
‚îî‚îÄ‚îÄ README.md            # Este archivo
```

### Scripts Disponibles
```bash
# Cliente
npm run dev          # Servidor de desarrollo
npm run build        # Build para producci√≥n
npm run preview      # Vista previa del build

# Servidor
npm run dev          # Servidor con hot reload
npm run start        # Servidor de producci√≥n
npm run test         # Ejecutar tests
```

## ü§ù Contribuci√≥n

1. Fork el proyecto
2. Crear rama feature (`git checkout -b feature/AmazingFeature`)
3. Commit cambios (`git commit -m 'Add some AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abrir Pull Request

## üìÑ Licencia

Este proyecto est√° bajo la Licencia MIT - ver el archivo [LICENSE](LICENSE) para detalles.

## üìû Contacto

**Equipo de Desarrollo**
- Email: desarrollo@legislatura.gov.ar
- Documentaci√≥n: [Wiki del Proyecto](link-to-wiki)
- Issues: [GitHub Issues](link-to-issues)

---

**Nota**: Este sistema est√° dise√±ado para modernizar los procesos legislativos mediante la implementaci√≥n de tecnolog√≠a blockchain, garantizando transparencia, trazabilidad y confianza en las decisiones democr√°ticas. 